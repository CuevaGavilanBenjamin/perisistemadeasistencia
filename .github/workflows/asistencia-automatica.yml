name: Sistema de Asistencia Automatizado

on:
  # Ejecutar cada hora
  schedule:
    - cron: '0 * * * *'  # Se ejecuta al minuto 0 de cada hora
  
  # TambiÃ©n permitir ejecuciÃ³n manual
  workflow_dispatch:
    inputs:
      force_run:
        description: 'Forzar ejecuciÃ³n (true/false)'
        required: false
        default: 'false'

jobs:
  procesar-asistencia:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout del repositorio
      uses: actions/checkout@v4
    
    - name: ğŸ Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ğŸ“¦ Instalar dependencias
      run: |
        python -m pip install --upgrade pip
        pip install pandas python-dotenv google-auth google-auth-oauthlib google-auth-httplib2 google-api-python-client pandasql openpyxl
    
    - name: ğŸ”§ Configurar variables de entorno
      env:
        GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
        GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
      run: |
        echo "âœ… Variables de entorno configuradas"
        echo "ğŸ“Š Sheet ID configurado: $(echo $GOOGLE_SHEET_ID | cut -c1-10)..."
        echo "ğŸ”‘ Credenciales JSON configuradas: $(echo $GOOGLE_SERVICE_ACCOUNT_JSON | wc -c) caracteres"
    
    - name: ğŸ¯ Ejecutar Sistema de Asistencia
      env:
        GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
        GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
      run: |
        echo "ğŸš€ Iniciando proceso de asistencia automatizado..."
        echo "â° Hora de ejecuciÃ³n: $(date)"
        echo "ğŸŒ Zona horaria: $(timedatectl show --property=Timezone --value)"
        
        python asistencia_automatica.py
        
        echo "âœ… Proceso completado"
        echo "â° Hora de finalizaciÃ³n: $(date)"
    
    - name: ğŸ“Š Resumen de ejecuciÃ³n
      if: always()
      run: |
        echo "=== RESUMEN DE EJECUCIÃ“N ==="
        echo "â° Fecha/Hora: $(date)"
        echo "ğŸ”„ Workflow: ${{ github.workflow }}"
        echo "ğŸ“ Commit: ${{ github.sha }}"
        echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
        
        if [ "${{ job.status }}" = "success" ]; then
          echo "âœ… Estado: Ã‰XITO"
        else
          echo "âŒ Estado: ERROR"
        fi
        
        echo "================================"

  # Trabajo adicional para notificaciones (opcional)
  notificar-resultado:
    needs: procesar-asistencia
    runs-on: ubuntu-latest
    if: always()  # Ejecutar siempre, sin importar si el trabajo anterior fallÃ³
    
    steps:
    - name: ğŸ“§ Resultado del procesamiento
      run: |
        echo "ğŸ“Š === RESULTADO DEL PROCESAMIENTO ==="
        
        if [ "${{ needs.procesar-asistencia.result }}" = "success" ]; then
          echo "âœ… El sistema de asistencia se ejecutÃ³ correctamente"
          echo "ğŸ‰ Todas las funciones completadas exitosamente"
        elif [ "${{ needs.procesar-asistencia.result }}" = "failure" ]; then
          echo "âŒ Error en el procesamiento de asistencia"
          echo "ğŸ” Revisar logs para mÃ¡s detalles"
        else
          echo "âš ï¸ Procesamiento cancelado o estado desconocido"
        fi
        
        echo "â° PrÃ³xima ejecuciÃ³n programada: En 1 hora"
        echo "==========================================="
