name: Sistema de Asistencia

on:
  # Ejecución programada a las 15:00 UTC (10:00 Perú)
  schedule:
    - cron: '0 15 * * *'  # 15:00 UTC diario (10:00 AM Perú)
  
  # Permitir ejecución manual
  workflow_dispatch:

jobs:
  sistema-asistencia:
    runs-on: ubuntu-latest
    
    steps:
    - name: 🕐 Debug - Información de ejecución
      run: |
        echo "🚀 === SISTEMA DE ASISTENCIA ==="
        echo "Event name: ${{ github.event_name }}"
        echo "UTC Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo "Peru Time: $(TZ='America/Lima' date '+%Y-%m-%d %H:%M:%S %Z')"
    
    - name: Checkout código
      uses: actions/checkout@v4
    
    - name: Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Instalar dependencias
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Crear archivo .env
      run: |
        echo "GOOGLE_SERVICE_ACCOUNT_FILE=sistemaasistencia-470019-3f3d35327bca.json" >> .env
        echo "GOOGLE_SHEET_ID=${{ secrets.GOOGLE_SHEET_ID }}" >> .env
        echo "GMAIL_USER=${{ secrets.GMAIL_USER }}" >> .env
        echo "GMAIL_APP_PASSWORD=${{ secrets.GMAIL_APP_PASSWORD }}" >> .env
    
    - name: Crear archivo de credenciales de Google
      run: |
        echo '${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}' > sistemaasistencia-470019-3f3d35327bca.json
    
    - name: Ejecutar Sistema de Asistencia
      run: |
        python sistema_asistencia.py
    
    - name: Subir reportes generados
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: reportes-asistencia-${{ github.run_number }}
        path: Reportes_Asistencia/
        retention-days: 30
